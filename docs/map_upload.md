# MAP Upload Process Documentation

## Overview

The `map_upload.py` script is responsible for downloading MAP (Measures of Academic Progress) assessment data from the NWEA API, extracting relevant CSV files, and uploading them to a designated Google Drive folder. This process is automated and runs daily via a cron job.

---

## How and When Does `map_upload.py` Run?

- **Trigger:**  
  The script is triggered by a cron job scheduled to run every day at 6:00 AM server time:
  ```
  0 6 * * * cd /home/data_admin/cadata/triggers && /usr/bin/python3 map_upload.py
  ```
- **Frequency:**  
  The script runs every day, regardless of whether it is a school day or not. There is no logic in the script to check for school days, holidays, or semester dates. It does not reference a calendar or any hard-coded date list to determine whether to run.
- **School-Specific Logic:**  
  There is no Opportunities Academy (OA) or other school-specific logic in the script as provided. The process is generic and runs the same way for all schools using the same credentials and folder ID.

---

## Data Sources

- **Source of Data:**  
  The script downloads a ZIP file from the NWEA MAP API endpoint:  
  `https://api.mapnwea.org/services/reporting/dex`
- **Authentication:**  
  Credentials for the API (`map_username` and `map_password`) are loaded from a `credentials` dictionary, which is defined in the imported `src.util` module.
- **Downloaded Content:**  
  The ZIP file is expected to contain at least two CSV files: `AssessmentResults.csv` and `StudentsBySchool.csv`.

---

## Process Flow

1. **Remove Old Files:**  
   Deletes any existing `map_output.zip`, `AssessmentResults.csv`, and `StudentsBySchool.csv` files to ensure a clean run.
2. **Download:**  
   Fetches the latest MAP data ZIP file from the NWEA API using basic authentication.
3. **Unzip:**  
   Extracts the contents of the ZIP file using the `7z` utility.
4. **Upload:**  
   Reads the `AssessmentResults.csv` file and uploads it to Google Drive using the `upload_basic` function, with a timestamped filename.

---

## Email Sending

- **From Address:**  
  The script itself does not send emails directly.

---

## Date Logic

- **School Days:**  
  The script does not check whether the current day is a school day, holiday, or weekend. It runs every day as scheduled by cron.
- **Date Range:**  
  The script does not specify or filter for a particular date range. It simply downloads the latest available data from the API.

---

## OA (Opportunities Academy) or School-Specific Logic

- There is no OA-specific or per-school logic in the script. All configuration (such as credentials and Google Drive folder ID) is generic and not dynamically selected based on the school.

---

## Typical Email Example

- **Not Applicable:**  
  Since the script does not generate or send emails directly, there is no typical email body to display. If notification emails are sent, they are managed by other parts of the system.

---

## Summary Table

| Aspect                | Details                                                                 |
|-----------------------|-------------------------------------------------------------------------|
| Trigger               | Daily at 6:00 AM via cron                                               |
| Runs on Non-School Days? | Yes, runs every day (no school calendar logic)                        |
| Data Source           | NWEA MAP API (`https://api.mapnwea.org/services/reporting/dex`)         |
| Credentials           | Loaded from `credentials` dictionary                                    |
| Output                | `AssessmentResults.csv` uploaded to Google Drive                        |
| Email From Address    | Not specified in this script                                            |
| OA/School Logic       | None                                                                    |
| Email Content         | Not generated by this script                                            |

---

If you need more details about the email process or school-specific logic, please check the implementation of `upload_basic` or related notification utilities in your codebase.
